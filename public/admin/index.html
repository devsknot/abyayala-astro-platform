<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administración de Contenido - Abya Yala</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <!-- Usar URL dinámica basada en la ubicación actual para el CSS -->
  <script>
    // Establecer la base URL dinámicamente
    window.appBaseUrl = window.location.origin;
    document.write(`<link rel="stylesheet" id="style-css" href="${window.appBaseUrl}/admin/style.css">`); 
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="p-4">
    <div class="loading flex flex-col items-center justify-center min-h-screen">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-500 mb-4"></div>
      <h2 class="text-xl font-semibold text-gray-700">Cargando panel de administración...</h2>
      <div id="loading-status" class="text-sm text-gray-500 mt-2">Inicializando...</div>
      <div id="debug-info" class="text-xs text-gray-400 mt-4 max-w-lg text-center"></div>
    </div>
  </div>
  
  <!-- Debug helper -->
  <script>
    // Función para actualizar el estado de carga
    function updateLoadingStatus(message) {
      const statusElement = document.getElementById('loading-status');
      if (statusElement) {
        statusElement.textContent = message;
      }
      console.log('[CMS DEBUG]', message);
    }
    
    // Función para mostrar información de depuración
    function showDebugInfo(message) {
      const debugElement = document.getElementById('debug-info');
      if (debugElement) {
        debugElement.innerHTML += `<div>${message}</div>`;
      }
      console.log('[CMS DEBUG]', message);
    }
    
    // Verificar el entorno
    showDebugInfo(`Entorno: ${window.location.hostname}`);
    showDebugInfo(`Ruta: ${window.location.pathname}`);
    showDebugInfo(`Origen: ${window.location.origin}`);
    
    // Capturar errores globales
    window.addEventListener('error', function(event) {
      showDebugInfo(`Error: ${event.message} en ${event.filename}:${event.lineno}`);
    });
  </script>
  
  <!-- Verificación de autenticación -->
  <script>
    updateLoadingStatus('Verificando autenticación...');
    
    // Usar la variable global para la URL base
    const basePath = window.appBaseUrl + '/admin/'; // Construir ruta absoluta completa
    
    // Si no estamos en la URL esperada, redirigir
    if (!window.location.pathname.includes('/admin')) {
      updateLoadingStatus('Redirigiendo a ruta correcta...');
      window.location.href = basePath;
    } else {
      // Verificar que el usuario esté autenticado
      const authData = localStorage.getItem('abyayala_cms_auth');
      if (!authData) {
        updateLoadingStatus('No hay sesión activa, redirigiendo a login...');
        setTimeout(() => {
          window.location.href = window.appBaseUrl + '/admin/login.html';
        }, 1000);
      } else {
        try {
          // Validar que el formato de autenticación sea correcto
          const auth = JSON.parse(authData);
          if (!auth.authenticated) {
            updateLoadingStatus('Sesión inválida, redirigiendo a login...');
            localStorage.removeItem('abyayala_cms_auth');
            setTimeout(() => {
              window.location.href = window.appBaseUrl + '/admin/login.html';
            }, 1000);
          } else {
            // Autenticación válida, cargar el resto de scripts
            updateLoadingStatus('Autenticación correcta, cargando componentes...');
            loadMainScripts();
          }
        } catch (error) {
          showDebugInfo(`Error al validar sesión: ${error.message}`);
          localStorage.removeItem('abyayala_cms_auth');
          setTimeout(() => {
            window.location.href = window.appBaseUrl + '/admin/login.html';
          }, 1000);
        }
      }
    }
    
    // Cargar los scripts principales
    function loadMainScripts() {
      updateLoadingStatus('Cargando scripts principales...');
      
      // Lista de scripts a cargar en orden
      const scripts = [
        `${window.appBaseUrl}/admin/components/notification.js`,
        `${window.appBaseUrl}/admin/content-manager.js`,
        `${window.appBaseUrl}/admin/components/article-manager.js`,
        `${window.appBaseUrl}/admin/components/media-library.js`,
        `${window.appBaseUrl}/admin/components/category-manager.js`,
        `${window.appBaseUrl}/admin/components/bulk-import-manager.js`,
        `${window.appBaseUrl}/admin/author-manager.js`,
        `${window.appBaseUrl}/admin/app.js`
      ];
      
      // Cargar scripts secuencialmente
      let scriptsLoaded = 0;
      
      function loadNextScript() {
        if (scriptsLoaded >= scripts.length) {
          // Todos los scripts cargados
          updateLoadingStatus('Scripts cargados. Inicializando aplicación...');
          return;
        }
        
        const scriptUrl = scripts[scriptsLoaded];
        const scriptName = scriptUrl.split('/').pop();
        updateLoadingStatus(`Cargando ${scriptName}...`);
        
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.onload = function() {
          scriptsLoaded++;
          showDebugInfo(`Script cargado: ${scriptName}`);
          loadNextScript(); // Cargar el siguiente script cuando este termine
        };
        script.onerror = function() {
          showDebugInfo(`Error al cargar script: ${scriptName}`);
          scriptsLoaded++; // Continuar con el siguiente script aunque haya error
          loadNextScript();
        };
        script.src = scriptUrl;
        document.body.appendChild(script);
      }
      
      // Iniciar la carga secuencial
      loadNextScript();
    }
  </script>
</body>
</html>
